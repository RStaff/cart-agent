#!/usr/bin/env bash
set -euo pipefail

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
cd "$ROOT"

FILES=(".env" "web/.env")

echo
echo "ðŸ” Paste your *SHOPIFY API SECRET KEY* (input hidden)."
echo "   NOT the API key. NOT client id."
echo "   Paste, then press ENTER."
echo

# Hidden input (works with paste)
IFS= read -r -s SECRET
echo

if [[ -z "${SECRET:-}" ]]; then
  echo "âŒ No input read (empty). Paste the secret key, then press ENTER."
  exit 1
fi

# Normalize: strip Windows CR if present
SECRET="${SECRET//$'\r'/}"

# Create + backup, then update key (no sed; use perl)
TS="$(date +%s)"

for f in "${FILES[@]}"; do
  mkdir -p "$(dirname "$f")" 2>/dev/null || true
  touch "$f"
  cp "$f" "$f.bak_${TS}"

  # Remove any existing definitions (SHOPIFY_API_SECRET or legacy SHOPIFY_API_SECRET_KEY)
  perl -i -pe '
    s/\r$//;
    if ($_ =~ /^(SHOPIFY_API_SECRET|SHOPIFY_API_SECRET_KEY)=/) { $_ = "" }
  ' "$f"

  # Ensure file ends with newline
  perl -0777 -i -pe '$_ .= "\n" unless /\n\z/' "$f"

  # Append the new secret
  printf 'SHOPIFY_API_SECRET=%s\n' "$SECRET" >> "$f"
done

# Fingerprint for verification (prints sha256 first 12)
FP="$(SECRET="$SECRET" node - <<'NODE'
import crypto from "node:crypto";
const s = process.env.SECRET || "";
const fp = crypto.createHash("sha256").update(s, "utf8").digest("hex").slice(0,12);
process.stdout.write(fp);
NODE
)"

echo "âœ… Wrote SHOPIFY_API_SECRET to: ${FILES[*]}"
echo "ðŸ§¾ Backups created: .env.bak_${TS} and web/.env.bak_${TS}"
echo "ðŸ”Ž secret_fp = ${FP}"
