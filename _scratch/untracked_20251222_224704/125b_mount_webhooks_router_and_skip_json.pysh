#!/usr/bin/env bash
set -euo pipefail

FILE="web/src/index.js"
test -f "$FILE" || { echo "âŒ Missing: $FILE"; exit 1; }

stamp="$(date +%s)"
cp "$FILE" "$FILE.bak_${stamp}"
echo "âœ… Backup: $FILE.bak_${stamp}"

python3 - << 'PY'
import re
from pathlib import Path

path = Path("web/src/index.js")
s = path.read_text(encoding="utf-8")

# 1) Ensure ESM import exists
imp = 'import webhooksRouter from "./routes/webhooks.js";'
if imp not in s:
    # insert after initial import block if possible
    m = re.match(r'(\s*(?:import[^\n]*;\s*\n)+)', s)
    if m:
        s = s[:m.end()] + imp + "\n" + s[m.end():]
    else:
        s = imp + "\n" + s

# 2) Ensure mount exists
mount = 'app.use("/api/webhooks", webhooksRouter);'
if mount not in s:
    # prefer insert after cookieParser
    m = re.search(r'(app\.use\(\s*cookieParser\(\)\s*\)\s*;\s*\n)', s)
    if m:
        s = s[:m.end()] + mount + "\n" + s[m.end():]
    else:
        # otherwise insert after app creation
        m2 = re.search(r'(const\s+app\s*=\s*express\(\)\s*;\s*\n)', s)
        if m2:
            s = s[:m2.end()] + mount + "\n" + s[m2.end():]
        else:
            # last resort: prepend near top
            s = mount + "\n" + s

# 3) Replace global express.json() with conditional skip for /api/webhooks
#    Important: webhook route must see RAW body (express.raw in routes/webhooks.js)
pattern = r'^\s*app\.use\(\s*express\.json\(\)\s*\)\s*;\s*$'
if re.search(pattern, s, flags=re.M):
    replacement = (
        'app.use((req, res, next) => {\n'
        '  const u = (req.originalUrl || req.url || "");\n'
        '  if (u.startsWith("/api/webhooks")) return next();\n'
        '  return express.json()(req, res, next);\n'
        '});'
    )
    s = re.sub(pattern, replacement, s, flags=re.M)

path.write_text(s, encoding="utf-8")
print("âœ… Patched index.js (import + mount + json-skip)")
PY

echo "ğŸ” Sanity check:"
node --check "$FILE"
echo "âœ… index.js parses"

echo
echo "ğŸ§¹ Free ports 3000/3001"
lsof -ti tcp:3000 | xargs -r kill -9 || true
lsof -ti tcp:3001 | xargs -r kill -9 || true

echo
echo "ğŸš€ Restarting dev stack"
./scripts/dev.sh cart-agent-dev.myshopify.com

echo
echo "âœ… Listening status:"
lsof -nP -iTCP:3000 -sTCP:LISTEN || true
lsof -nP -iTCP:3001 -sTCP:LISTEN || true

echo
echo "ğŸ§ª Validate webhook route exists (expect 401 missing hmac when bypass OFF):"
curl -i http://localhost:3000/api/webhooks -X POST -H "Content-Type: application/json" -d '{}' | sed -n '1,30p' || true

echo
echo "ğŸ” Tail express log (last 120):"
tail -n 120 .dev_express.log || true

echo
echo "âœ… Done."
